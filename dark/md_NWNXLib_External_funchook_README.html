<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=9"/>
		<meta name="generator" content="Doxygen 1.8.17"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<title>NWNX:EE: Funchook - an API hook library</title>
                <link href="logo-transparent.png" rel="shortcut icon" type="image/x-icon">
                <link href="logo-transparent.png" rel="apple-touch-icon-precomposed">
		<link href="tabs.css" rel="stylesheet" type="text/css"/>
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript" src="dynsections.js"></script>
		<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
		<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
		<link href="doxygen.css" rel="stylesheet" type="text/css" />
		<link href="custom_dark_theme.css" rel="stylesheet" type="text/css"/>
	</head>
	<body>
	<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
		<div id="titlearea">
			<table cellspacing="0" cellpadding="0">
				<tbody>
					<tr style="height: 56px;">
						<td id="projectlogo"><img width="80" height="74" alt="Logo" src="logo-transparent.png"/></td>
						<td id="projectalign" style="padding-left: 0.5em;">
							<div id="projectname">NWNX:EE
								&#160;<span id="projectnumber">8193.36.12</span>
							</div>
						</td>
						<td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
					</tr>
				</tbody>
			</table>
		</div>
		<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_NWNXLib_External_funchook_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Funchook - an API hook library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://github.com/kubo/funchook/actions/workflows/run-tests.yml"><object type="image/svg+xml" data="https://github.com/kubo/funchook/actions/workflows/run-tests.yml/badge.svg?branch=master" style="pointer-events: none;">tests</object></a></p>
<p>This library depends on one of the following disassemblers.</p>
<p>On x86_64 and x86</p><ul>
<li><a href="https://github.com/gdabah/distorm/">diStorm3</a> (default)</li>
<li><a href="https://github.com/zyantific/zydis">zydis</a> (when <code>-DFUNCHOOK_DISASM=zydis</code> is passed to the <code>cmake</code> command)</li>
<li><a href="https://github.com/aquynh/capstone">capstone</a> (when <code>-DFUNCHOOK_DISASM=capstone</code> is passed to the <code>cmake</code> command)</li>
</ul>
<p>On arm64</p><ul>
<li><a href="https://github.com/aquynh/capstone">capstone</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md216"></a>
TODO</h1>
<ul>
<li>write documents.</li>
</ul>
<h1><a class="anchor" id="autotoc_md217"></a>
News</h1>
<h2><a class="anchor" id="autotoc_md218"></a>
2.0.0 (20XX-XX-XX)</h2>
<ul>
<li>Add <code>funchook_prepare_with_params()</code> to support prehook.</li>
<li>Add <code>funchook_get_arg()</code> to get arguments in prehook.</li>
</ul>
<h2><a class="anchor" id="autotoc_md219"></a>
1.1.2 (2023-03-12)</h2>
<ul>
<li>Experimental support for Windows arm64</li>
</ul>
<h2><a class="anchor" id="autotoc_md220"></a>
1.1.1 (2022-10-02)</h2>
<ul>
<li>More permissive check for page allocation mmap (<a href="https://github.com/kubo/funchook/pull/25">#25</a>)</li>
<li>Flush instruction cache for arm64. It does nothing for intel CPU.</li>
<li>Disassember engine<ul>
<li>Upgrade capstone to 4.0.2</li>
<li>Upgrade distorm to 3.5.2</li>
</ul>
</li>
<li>CMake<ul>
<li>Allow user to specify FUNCHOOK_CPU explicitly (<a href="https://github.com/kubo/funchook/pull/19">#19</a>)</li>
<li>Avoid polluting global include and link dirs (<a href="https://github.com/kubo/funchook/pull/20">#20</a>)</li>
<li>Use target based compile options for gcc's -Wall (<a href="https://github.com/kubo/funchook/pull/21">#21</a>)</li>
<li>Use ExternalProject_add to download captone only (<a href="https://github.com/kubo/funchook/pull/30">#30</a>)</li>
<li>Add option FUNCHOOK_INSTALL (<a href="https://github.com/kubo/funchook/pull/31">#31</a>)</li>
<li>Use "FUNCHOOK_CPU MATCHES &lt;string&gt;" (<a href="https://github.com/kubo/funchook/pull/32">#32</a>)</li>
</ul>
</li>
<li>Documentation<ul>
<li>added example usage from python (<a href="https://github.com/kubo/funchook/pull/22">#22</a>)</li>
</ul>
</li>
<li>Fix tests on Android (<a href="https://github.com/kubo/funchook/pull/29">#29</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md221"></a>
1.1.0 (2020-03-22)</h2>
<ul>
<li>Arm64 Linux support. <a href="https://github.com/aquynh/capstone">capstone</a> is used as the disassembler library on arm64.</li>
<li>Options to use <a href="https://github.com/zyantific/zydis">zydis</a> and <a href="https://github.com/aquynh/capstone">capstone</a> as a disassembler library on x86_64 and x86.</li>
<li><code>extern "C"</code> was added in funchook.h for C++. (<a href="https://github.com/kubo/funchook/issues/15">#15</a>)</li>
<li>Libc-compatible functions were removed to simplify code.</li>
</ul>
<h2><a class="anchor" id="autotoc_md222"></a>
1.0.0 (2020-01-19)</h2>
<ul>
<li><a href="https://github.com/gdabah/distorm/">diStorm3</a> is used as the disassembler library.</li>
<li>Libc-compatible functions were implemented on Linux in order not to hook function calls issued by funchook itself.</li>
</ul>
<h1><a class="anchor" id="autotoc_md223"></a>
Supported Platforms</h1>
<ul>
<li>Linux x86_64</li>
<li>Linux x86</li>
<li>Linux arm64 (since 1.1.0)</li>
<li>macOS x86_64 (Functions in executables cannot be hooked when Xcode version &gt;= 11.0. (*1))</li>
<li>Windows x64 (except C-runtime functions under <a href="https://www.winehq.org/">Wine</a>)</li>
<li>Windows 32-bit</li>
</ul>
<p>*1 <a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/mprotect.2.html"><code>mprotect</code></a> fails with EACCES. <br  />
</p>
<h1><a class="anchor" id="autotoc_md224"></a>
Tested Platforms</h1>
<p>Tested on some versions. Not tested in CI.</p>
<ul>
<li>Windows arm64 (version 1.1.2)</li>
</ul>
<h1><a class="anchor" id="autotoc_md225"></a>
Unsupported Platforms</h1>
<ul>
<li>macOS arm64 (*1)</li>
<li>x64/x86 emulation for Windows arm64</li>
</ul>
<p>*1 I received a mail that <a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/mprotect.2.html"><code>mprotect</code></a> failed with <code>EINVAL</code>. Apple seems to prevent executable memory regions from being writable.</p>
<h1><a class="anchor" id="autotoc_md226"></a>
Compilation and installation</h1>
<h2><a class="anchor" id="autotoc_md227"></a>
Unix</h2>
<div class="fragment"><div class="line">$ git clone --recursive https://github.com/kubo/funchook.git</div>
<div class="line">$ mkdir build</div>
<div class="line">$ cd build</div>
<div class="line">$ cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/path/to/install/directory ../funchook</div>
<div class="line">$ make</div>
<div class="line">$ make install</div>
</div><!-- fragment --><ul>
<li>Available <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html"><code>CMAKE_BUILD_TYPE</code></a> values are empty(default), <code>Debug</code>, <code>Release</code>, <code>RelWithDebInfo</code>(release build with debug information) and <code>MinSizeRel</code>.</li>
<li><p class="startli">When <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_INSTALL_PREFIX.html"><code>CMAKE_INSTALL_PREFIX</code></a> isn't set, funchook is installed at <code>/usr/local</code>.</p>
<p class="startli">installed files:</p><ul>
<li><code>${CMAKE_INSTALL_PREFIX}/include/funchook.h</code> (header file)</li>
<li><code>${CMAKE_INSTALL_PREFIX}/lib/libfunchook.so</code> (symbolic link to <code>libfunchook.so.1</code>)</li>
<li><code>${CMAKE_INSTALL_PREFIX}/lib/libfunchook.so.1</code> (<a href="https://en.wikipedia.org/wiki/Soname">soname</a>; symbolic link to <code>libfunchook.so.1.1.0</code>)</li>
<li><code>${CMAKE_INSTALL_PREFIX}/lib/libfunchook.so.1.1.0</code> (shared library)</li>
<li><code>${CMAKE_INSTALL_PREFIX}/lib/libfunchook.a</code> (static library)</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md228"></a>
Windows</h2>
<p>Here is an example to compile funchook with Visual Studio 2017 Win64. Change the argument of <code>-G</code> to use other compilers.</p>
<div class="fragment"><div class="line">$ git clone --recursive https://github.com/kubo/funchook.git</div>
<div class="line">$ mkdir build</div>
<div class="line">$ cd build</div>
<div class="line">$ cmake -G &quot;Visual Studio 15 2017 Win64&quot; -DCMAKE_INSTALL_PREFIX=c:\path\to\install\directory ..\funchook</div>
<div class="line">$ cmake --build . --config Release --target INSTALL</div>
</div><!-- fragment --><ul>
<li>Available <code>-G</code> arguments (generators) are listed in the output of <code>cmake --help</code>.</li>
<li>Available <code>--config</code> arguments are <code>Debug</code>(default), <code>Release</code>, <code>RelWithDebInfo</code> and <code>MinSizeRel</code>.</li>
<li><p class="startli">When <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_INSTALL_PREFIX.html"><code>CMAKE_INSTALL_PREFIX</code></a> isn't set, funchook is installed at <code>c:\Program Files\funchook</code>.</p>
<p class="startli">installed files:</p><ul>
<li><code>${CMAKE_INSTALL_PREFIX}\include\funchook.h</code> (header file)</li>
<li><code>${CMAKE_INSTALL_PREFIX}\bin\funchook.dll</code> (shared library)</li>
<li><code>${CMAKE_INSTALL_PREFIX}\bin\funchook.pdb</code> (debug file for <code>funchook.dll</code> when <code>--config</code> is <code>Debug</code> or <code>RelWithDebInfo</code>)</li>
<li><code>${CMAKE_INSTALL_PREFIX}\lib\funchook.lib</code> (static library)</li>
<li><code>${CMAKE_INSTALL_PREFIX}\lib\funchook_dll.lib</code> (import library for <code>funchook.dll</code>)</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md229"></a>
Example</h1>
<div class="fragment"><div class="line"><span class="keyword">static</span> ssize_t (*send_func)(<span class="keywordtype">int</span> sockfd, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> len, <span class="keywordtype">int</span> flags);</div>
<div class="line"><span class="keyword">static</span> ssize_t (*recv_func)(<span class="keywordtype">int</span> sockfd, <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> len, <span class="keywordtype">int</span> flags);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t send_hook(<span class="keywordtype">int</span> sockfd, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> len, <span class="keywordtype">int</span> flags)</div>
<div class="line">{</div>
<div class="line">    ssize_t rv;</div>
<div class="line"> </div>
<div class="line">    ... <span class="keywordflow">do</span> your task: logging, etc. ...</div>
<div class="line">    rv = send_func(sockfd, buf, len, flags); <span class="comment">/* call the original send(). */</span></div>
<div class="line">    ... <span class="keywordflow">do</span> your task: logging, checking the <span class="keywordflow">return</span> value, etc. ...</div>
<div class="line">    <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t recv_hook(<span class="keywordtype">int</span> sockfd, <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> len, <span class="keywordtype">int</span> flags)</div>
<div class="line">{</div>
<div class="line">    ssize_t rv;</div>
<div class="line"> </div>
<div class="line">    ... <span class="keywordflow">do</span> your task: logging, etc. ...</div>
<div class="line">    rv = recv_func(sockfd, buf, len, flags); <span class="comment">/* call the original recv(). */</span></div>
<div class="line">    ... <span class="keywordflow">do</span> your task: logging, checking received data, etc. ...</div>
<div class="line">    <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> install_hooks()</div>
<div class="line">{</div>
<div class="line">    funchook_t *funchook = funchook_create();</div>
<div class="line">    <span class="keywordtype">int</span> rv;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Prepare hooking.</span></div>
<div class="line"><span class="comment">     * The return value is used to call the original send function</span></div>
<div class="line"><span class="comment">     * in send_hook.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    send_func = send;</div>
<div class="line">    rv = funchook_prepare(funchook, (<span class="keywordtype">void</span>**)&amp;send_func, send_hook);</div>
<div class="line">    <span class="keywordflow">if</span> (rv != 0) {</div>
<div class="line">       <span class="comment">/* error */</span></div>
<div class="line">       ...</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* ditto */</span></div>
<div class="line">    recv_func = recv;</div>
<div class="line">    rv = funchook_prepare(funchook, (<span class="keywordtype">void</span>**)&amp;recv_func, recv_hook);</div>
<div class="line">    <span class="keywordflow">if</span> (rv != 0) {</div>
<div class="line">       <span class="comment">/* error */</span></div>
<div class="line">       ...</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Install hooks.</span></div>
<div class="line"><span class="comment">     * The first 5-byte code of send() and recv() are changed respectively.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    rv = funchook_install(funchook, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (rv != 0) {</div>
<div class="line">       <span class="comment">/* error */</span></div>
<div class="line">       ...</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md230"></a>
Example - Using Python ctypes</h1>
<div class="fragment"><div class="line"># should work on python 2.7/3 windows/linux</div>
<div class="line"> </div>
<div class="line"># load funchook</div>
<div class="line">import ctypes</div>
<div class="line">fh_lib = ctypes.cdll.LoadLibrary(&#39;/path/to/funchook/dll/or/so&#39;)</div>
<div class="line"> </div>
<div class="line"># define signatures</div>
<div class="line">funchook_create = fh_lib.funchook_create</div>
<div class="line">funchook_create.restype = ctypes.c_void_p</div>
<div class="line">funchook_create.argtypes = []</div>
<div class="line"> </div>
<div class="line">funchook_prepare = fh_lib.funchook_prepare</div>
<div class="line">funchook_prepare.restype = ctypes.c_ssize_t</div>
<div class="line">funchook_prepare.argtypes = [ctypes.c_void_p, ctypes.c_void_p, ctypes.c_void_p]</div>
<div class="line"> </div>
<div class="line">funchook_install = fh_lib.funchook_install</div>
<div class="line">funchook_install.restype = ctypes.c_ssize_t</div>
<div class="line">funchook_install.argtypes = [ctypes.c_void_p, ctypes.c_int]</div>
<div class="line"> </div>
<div class="line">PySys_WriteStdout = ctypes.pythonapi.PySys_WriteStdout</div>
<div class="line">PySys_WriteStdout.restype = None</div>
<div class="line">PySys_WriteStdout.argtypes=[ctypes.c_char_p]</div>
<div class="line"> </div>
<div class="line"># must keep those references alive, or stuff will be GC&#39;d and weird errors will occur</div>
<div class="line">global orig_write, hook, orig_write_ptr</div>
<div class="line"> </div>
<div class="line"># create hook (this function will replace the original function)</div>
<div class="line">hook_type = ctypes.PYFUNCTYPE(None, ctypes.c_char_p)</div>
<div class="line">orig_write = None</div>
<div class="line">def hook_impl(msg):</div>
<div class="line">    print(&#39;about to write: &#39; + str(msg)) # do what we want</div>
<div class="line">    orig_write(msg)                      # call the original function</div>
<div class="line"> </div>
<div class="line">hook = hook_type(hook_impl)</div>
<div class="line"> </div>
<div class="line">fh = funchook_create()</div>
<div class="line"># create a pointer object with the function address</div>
<div class="line">orig_write_ptr = ctypes.c_void_p(ctypes.c_void_p.from_address(ctypes.addressof(PySys_WriteStdout)).value)</div>
<div class="line"># orig_write_ptr.value will get a ptr to the original PySys_WriteStdout and PySys_WriteStdout will now point to the hook</div>
<div class="line">ret = funchook_prepare(fh, ctypes.addressof(orig_write_ptr), hook)</div>
<div class="line">assert not ret, &#39;ret is &#39; + str(ret)</div>
<div class="line">ret = funchook_install(fh, 0)</div>
<div class="line">assert not ret, &#39;ret is &#39; + str(ret)</div>
<div class="line">orig_write = hook_type.from_address(ctypes.addressof(orig_write_ptr))</div>
<div class="line">PySys_WriteStdout(b&#39;hi there\n&#39;)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md231"></a>
License</h1>
<p>GPLv2 or later with a <a href="https://en.wikipedia.org/wiki/GPL_linking_exception">GPL linking exception</a>.</p>
<p>You can use funchook in any software. Though funchook is licensed under the GPL, it doesn't affect outside of funchook due to the linking exception. You have no need to open your souce code under the GPL except funchook itself.</p>
<p>If you modify funchook itself and release it, the modifed part must be open under the GPL with or without the linking exception because funchook itself is under the GPL.</p>
<p><a href="https://github.com/gdabah/distorm/">diStorm3</a> and <a href="https://github.com/aquynh/capstone">capstone</a> are released under the 3-clause BSD license. <a href="https://github.com/zyantific/zydis">zydis</a> is released under the MIT license. They are compatible with the GPL. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
		<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
			<ul>
				<li class="footer">
					Generated on Tue Oct 22 2024 12:02:08 for NWNX:EE by <a href="http://www.doxygen.org/index.html">
					<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17.
					<a href="../">Light version</a>
				</li>
			</ul>
		</div>
		<script src="custom.js"></script>
	</body>
</html>
